!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Parser=e()}}(function(){return function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return o(n?n:e)},u,u.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t){function n(){c=!1,s.length?l=s.concat(l):u=-1,l.length&&r()}function r(){if(!c){var e=setTimeout(n);c=!0;for(var t=l.length;t;){for(s=l,l=[];++u<t;)s[u].run();u=-1,t=l.length}s=null,c=!1,clearTimeout(e)}}function o(e,t){this.fun=e,this.array=t}function i(){}var s,a=t.exports={},l=[],c=!1,u=-1;a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new o(e,t)),1!==l.length||c||setTimeout(r,0)},o.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=i,a.addListener=i,a.once=i,a.off=i,a.removeListener=i,a.removeAllListeners=i,a.emit=i,a.binding=function(){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},{}],2:[function(e,t){function n(e){this.nodes={},this.lines={},this.ids={},this.instances=a(e.instances,{}),this.moduleInfo=a(e.moduleInfo,{}),this.appService=a(e.appService,{}),this.addInstances()}var r=e("./node"),o=e("./node/subelm"),i=e("./line"),s=e("typpy"),a=e("deffy"),l=e("iterate-object"),c=e("ul"),u=e("enny"),p=e("./parsers");n.prototype.get=function(e){return s(e,String)?this.ids[e]:s(e,Object)?this.get(new r.Id(e).toString()):null},n.prototype.addNode=function(e,t){return e=new r(e,t),this.nodes[e.id]=this.ids[e.id]=e},n.prototype.addLine=function(e){return e=new i(e),s(e.source,o)&&(e.source.lines[e.id]=e),this.lines[e.id]=this.ids[e.id]=e},n.prototype.connect=function(e,t,n){var r,o=this,i=[],a=!1;return(a=s(e,Array))||s(t,Array)?(r=(a?e:t).map(a?function(e){return o.connect(e,t,n)}:function(t){return o.connect(e,t,n)}),l(r,function(e){return s(e,Array)?l(e,function(e){i.push(e)}):void i.push(e)}),i):this.addLine(c.merge(n,{source:e,target:t}))},n.prototype.prepare=function(){var e={nodes:{},lines:{}};return l(this.nodes,function(t,n){var r=e.nodes[n]={id:t.id.toString(),isServer:t.id.isServer,color:t.color,domains:t.domains,icon:t.icon,name:t.label,_name:t.name,subelms:{},pos:t.pos,flow:t.flow,pFlow:t.pFlow};l(t.subelms,function(e,t){var n={},o=r.subelms[t]={id:e.id.toString(),label:e.label,type:e.type,icon:e.icon,lines:n};e.flowLines&&(o.flowLines=e.flowLines.map(function(e){return e.map(function(e){return e.id.toString()})})),l(e.lines,function(e,t){n[t]={source:e.source.id.toString(),target:e.target.id.toString(),id:t,classes:e.source}})})}),l(this.lines,function(t,n){e.lines[n]={source:t.source.id.toString(),target:t.target.id.toString(),id:t.id.toString(),classes:t.classes}}),e},n.prototype.addModuleFlow=function(e){var t=null;e=c.deepMerge(e,{client:{flow:[]},flow:[]});var n=null;if(s(e.module,Object))n=c.deepMerge(e.module,{client:{flow:[]},flow:[]});else{if(!s(t=this.moduleInfo[e.module],Object))return e;n=t["package"].composition}return e.flow=n.flow.concat(e.flow),e.client.flow=n.client.flow.concat(e.client.flow),e},n.prototype.addInstance=function(e,t){var n=this,r=null,o=null;e=n.addModuleFlow(c.clone(e)),o=n.addNode(e,t),r=Object(n.appService.e)[o.id],r&&(r.color&&o.setColor(r.color),r.pos&&o.position(r.pos)),e.flow&&e.flow.length&&!t&&n.addInstance(e,!0)},n.prototype.addInstances=function(e){var t=this;e=e||t.instances,l(e,function(e){t.addInstance(e)})},n.prototype.parseFlow=function(){var e=this;l(e.nodes,function(e){l(e.pFlow,function(t,n){for(var r=0;r<t.length;++r)e.getOrAddSubElm(u.TYPES.listener.name,{event:n,index:r})})})},n.prototype.addConnections=function(){var e=this;l(e.nodes,function(t){l(t.load,function(n){var r=e.get({name:n,isServer:t.id.isServer});e.connect(t,r)}),l(t.pFlow,function(n,r){l(n,function(n,o){function i(e){if(s(e,Array)){if(0===e.length)return;return a.flowLines.push(e)}i([e])}var a=t.getOrAddSubElm(u.TYPES.listener.name,{event:r,index:o});a.flowLines=[];var c={error:[],data:[]},d=[],f=a,h=a,y=h;d.push(f),l(n,function(n,r,o){function s(n,r,o){var s=e.get({name:n.instance,isServer:t.id.isServer}),a=s.getOrAddSubElm(p.ConvertToOn(n),n);i(e.connect(b,a)),b=y=a,r===o.length-1&&w!==y&&i(e.connect(y,w))}function h(){b=f,l(c.data,s),b=f,l(c.error,s),b=y=w,b=f=w}function m(){var t=d.slice(-2),n=t[0],r=t[1];n&&r&&!r.disableInput&&i(e.connect(r,n,{classes:["input"]}))}var v=null;if(u.TYPES(n.type,u.TYPES.load))return void l(n.args[0],function(n){v=e.get({name:n,isServer:t.id.isServer}),i(e.connect(a,v))});v=e.get({name:n.instance,isServer:!!n.serverMethod||t.id.isServer});var g=p.ConvertToOn(n),w=v.getOrAddSubElm(g,n),S=u.TYPES(g,u.TYPES.listener);if(S&&(w=v.getListeners(n.event),!w.length))return void console.warn("No listener.",n);if(!w)return void console.warn("Cannot found the target element",n);var b=f;switch((n.type===u.TYPES.link||n.type===u.TYPES.streamHandler||n.type===u.TYPES.emit)&&d.push(w),n.type){case u.TYPES.streamHandler:case u.TYPES.emit:case u.TYPES.link:return c.data.length||c.error.length?h():i(e.connect(f,w)),void m();case u.TYPES.dataHandler:case u.TYPES.errorHandler:c[["error","data"][Number(u.TYPES(n.type,u.TYPES.dataHandler))]].push(n)}r===o.length-1&&(h(),m())})})})})},n.Parsers=e("./parsers"),t.exports=n},{"./line":3,"./node":4,"./node/subelm":5,"./parsers":9,deffy:13,enny:14,"iterate-object":17,typpy:19,ul:20}],3:[function(e,t){function n(e){this.source=e.source,this.target=e.target,this.id=this.source.id+"_"+this.target.id+"_"+i(),this.classes=r(e.classes,[]),e.classes||this.classes.push(o.LineType(this.source,this.target)),this.classes=this.classes.map(function(e){return"line-"+e})}var r=e("deffy"),o=(e("enny"),e("../parsers")),i=e("idy");t.exports=n},{"../parsers":9,deffy:13,enny:14,idy:16}],4:[function(e,t){function n(e,t){t=i(t,!!e.isServer),this.isServer=t,this.side=["Client","Server"][Number(t)],this.name=e.name}function r(e,t){t=i(t,!1),this.id=new n(e,t),this.icon=i(e.icon,"&#xf0c0"),this.subelms={},this.label=e.name+" ("+this.id.side+")",this.domains=[],this.name=e.name,this.flow=i(t?e.flow:e.client&&e.client.flow,[]),this.load=i(t?e.load:e.client&&e.client.load,[]),this.pFlow=a.FlowElements(this.flow,this.name),this.raw=e}var o=e("typpy"),i=e("deffy"),s=e("./subelm"),a=e("../parsers"),l=e("enny"),c=e("iterate-object"),u="instance",p="_";n.prototype.toString=function(){return[u,this.side,this.name].join(p)},r.Id=n,r.prototype.hasFlow=function(){return!!this.flow.length},r.prototype.setColor=function(e){return this.color=[this.color,e][arguments.length]},r.prototype.position=function(e,t){return o(e,Number)&&o(t,Number)?this.position({x:e,y:t}):o(e,Object)&&o(e.x,Number)&&o(e.y,Number)?void(this.pos=e):this.pos},r.prototype.addSubElement=function(e,t){return t=o(e,s)?e:new s(e,t,this),this.subelms[t.id]&&console.warn("Override",t),this.subelms[t.id]=t},r.prototype.getListeners=function(e){var t=new s(l.TYPES.listener.name,{event:e},this),n=t.id.toString(!0),r=[];return c(this.subelms,function(e){e.id.toString(!0)===n&&r.push(e)}),r},r.prototype.getOrAddSubElm=function(e,t){var n=new s(e,t,this);return this.subelms[n.id]?this.subelms[n.id]:this.addSubElement(n)},t.exports=r},{"../parsers":9,"./subelm":5,deffy:13,enny:14,"iterate-object":17,typpy:19}],5:[function(e,t){function n(e,t,n){i(e,r)&&(n=t,t=e.name,this.index=e.index,e=e.type),this.index=o(this.index,0),this.type=e,this.name=t,this.parentId=n}function r(e,t,a){return i(t,r)?t:("string"==typeof e&&(e=s.TYPES[e]),this.index=0,i(t.index,Number)&&(this.index=t.index),this.icon=e.icon,this.name=r.Name(t),this.label=o(t.label,this.name),this.disableInput=t.disableInput,this.type=e.type,this.id=new n(this,a.id),void(this.lines={}))}var o=e("deffy"),i=e("typpy"),s=e("enny"),a="__";n.prototype.toString=function(e){return[this.type,this.parentId,this.name,e?"":this.index].join(a)},r.Name=function(e){return e.name||e.event||e.serverMethod||e.method},r.Id=n,t.exports=r},{deffy:13,enny:14,typpy:19}],6:[function(e,t){var n=e("enny");t.exports=function(e){return e.serverMethod||n.TYPES(e.type,n.TYPES.emit)||n.TYPES(e.type,n.TYPES.link)?n.TYPES.listener:e.type}},{enny:14}],7:[function(e,t){var n=e("./method"),r=e("enny"),o=e("ul"),i=e("typpy");t.exports=function(e,t){var s=o.clone(e);i(s,String)&&(s=[s]);var a={},l=null,c=null;return s[0]===r.TYPES.load.handler?(a.type=r.TYPES.load,a.args=s.slice(1)):"flow"===(l=n(s[0],t)).method&&(r.TYPES((c=n(s[1],t)).type,r.TYPES.link)?(a=c,a.type=r.TYPES.link,a.serverMethod=a.method,a.event=a.method):(a=l,a.type=r.TYPES.emit,a.event=s[1])),a.type||(a=n(s[0],t),a.args=s.slice(1)),a}},{"./method":11,enny:14,typpy:19,ul:20}],8:[function(e,t){var n=e("./flow-component"),r=e("iterate-object"),o=e("set-or-get");t.exports=function(e,t){var i={};return r(e,function(e){var s=o(i,e[0],[]),a=[];r(e.slice(1),function(e){a.push(n(e,t))}),s.push(a)}),i}},{"./flow-component":7,"iterate-object":17,"set-or-get":18}],9:[function(e,t){t.exports={Method:e("./method"),FlowComponent:e("./flow-component"),FlowElements:e("./flow-elements"),LineType:e("./line-type"),ConvertToOn:e("./convert-to-on")}},{"./convert-to-on":6,"./flow-component":7,"./flow-elements":8,"./line-type":10,"./method":11}],10:[function(e,t){var n=e("enny"),r=e("deffy");t.exports=function(e,t){return!r(e.id.parentId,{},!0).isServer&&r(t.id.parentId,{},!0).isServer?"link-in":n.TYPES(t.type,n.TYPES.errorHandler)?"error-in":n.TYPES(e.type,n.TYPES.errorHandler)?"error-out":n.TYPES(e.type,n.TYPES.dataHandler)?"data-out":"normal"}},{deffy:13,enny:14}],11:[function(e,t){var n=e("enny");t.exports=function(e,t){var r={instance:t,type:n.TYPES.streamHandler};switch(e.charAt(0)){case"!":r.type=n.TYPES.errorHandler,e=e.substr(1);break;case":":r.type=n.TYPES.dataHandler,e=e.substr(1);break;case">":r.disableInput=!0,r.type=n.TYPES.streamHandler,e=e.substr(1);break;case"@":r.type=n.TYPES.link,e=e.substr(1)}var o=e.split("/");return 2===o.length?(r.instance=o[0],r.method=o[1]):r.method=o[0],r}},{enny:14}],12:[function(e,t){function n(e,t,n,o){var i=new r({instances:e||{},appService:t||{},moduleInfo:n||{}});i.parseFlow(),i.addConnections(),o(null,i)}var r=(e("typpy"),e("./composition/node"),e("./composition"));"object"==typeof window&&(window.EngineParser=n),t.exports=n},{"./composition":2,"./composition/node":4,typpy:19}],13:[function(e,t){function n(e,t,n){return"function"==typeof t?t(e):(n="boolean"===r(n)?{empty:n}:{empty:!1},n.empty?e||t:r(e)===r(t)?e:t)}var r=e("typpy");t.exports=n},{typpy:19}],14:[function(e,t){function n(){var e=this;e.instances={},e.Instance=function(t){return new n.Instance(t,{enny:e})},e.FlowComponent=function(t){return new n.FlowComponent(t,{enny:e})}}var r=e("ul"),o=e("typpy"),i=e("deffy"),s=e("map-o"),a=function(){function e(e,t){return e&&t?("string"==typeof e&&(e={type:e}),"string"==typeof t&&(t={type:t}),e.type===t.type):!1}return e.dataHandler={icon:"f087"},e.errorHandler={icon:"f02d"},e.streamHandler={icon:"f0c4"},e.load={handler:"LOAD"},e.emit={icon:"f077",handler:"flow"},e.link={icon:"f05c",handler:"flow"},e.listener={icon:"f030"},s(e,function(e,t){return t.icon&&(t.icon="&#x"+t.icon),t.type=e,t.name=e,t}),e}();n.prototype.toObject=function(){return JSON.parse(JSON.stringify(this))},n.prototype.toJSON=function(){var e=this,t={};return Object.keys(e.instances).forEach(function(n){t[n]=e.instances[n]._}),t},n.prototype.addInstance=function(e){return e=this.Instance(e),this.instances[e._.name]=e,e},n.Instance=function(e,t){return"instance"===o(e)?e:(this._=r.clone(e),void(this.enny=t.enny))},n.Instance.prototype.connect=function(e,t,o){var s=this;if("boolean"==typeof t?t={client:t}:"function"===t&&(o=t,t={}),o=o||function(e){e&&console.error(e)},t=r.merge(t,{client:!0,save:!1}),e=n.Instance(e,t),!e._.name)return o(new Error("The target instance name is required."));if(!s._.name)return o(new Error("The source instance name is required."));var a=null;return t.client?(s._.client=i(s._.client,{}),a=s._.client.load=i(s._.client.load,[])):a=s._.load=i(s._.load,[]),a.push(e._.name),t.save?(s.enny.save(o),s):(o(),s)},n.Instance.prototype.addFlow=function(e,t,o){var s=this;"boolean"==typeof t?t={client:t}:"function"===t&&(o=t,t={}),o=o||function(e){e&&console.error(e)},t=r.merge(t,{client:!0});var a=null;return t.client?(s._.client=i(s._.client,{}),a=s._.client.flow=i(s._.client.flow,[])):a=s._.flow=i(s._.flow,[]),e=new n.FlowElement(e),a.push(e),t.save?(s.enny.save(o),s):void o()},n.Instance.prototype.toObject=function(){return JSON.parse(JSON.stringify(this))._},n.FlowElement=function(e){var t=this;return"flowelement"===o(e)?e:(this._=[],void("array"===o(e)&&e.forEach(t.addComponent.bind(t))))},n.FlowElement.prototype.toJSON=function(){return this._.map(function(e){return e.toFlow()})},n.FlowElement.prototype.addComponent=function(e){e=new n.FlowComponent(e),this._.push(e)},n.FlowElement.prototype.toFlow=function(){return this._.map(function(e){return e.toFlow()})},n.Handler=function(e){return"handler"===o(e)?e:(this.to=e.to,this.args=i(e.args,[]),this.isStream=i(e.isStream,!0),this.isError=i(e.isError,!1),this.handler=e.handler,this.isLink=e.isLink,void(this.args.length&&e.isLink&&(this.args[0]="@"+(this.to?this.to+"/":"")+this.args[0])))},n.Handler.prototype.toFlow=function(){var e=[];return e[0]=(this.isStream?"":this.isError?"!":":")+(this.to&&!this.isLink?this.to+"/":"")+this.handler,this.args.length?e=e.concat(this.args):e[0]},n.FlowComponent=function(e){var t=this;return"flowcomponent"===o(e)?e:(e.event&&(e.type=a.listener),e.stream&&(e.type=a.streamHandler,e.handler=e.stream),e.data&&(e.type=a.dataHandler,e.handler=e.data),e.error&&(e.type=a.errorHandler,e.handler=e.error),e.link&&(e.type=a.link),e.emit&&(e.type=a.emit,e.event=e.emit),e.load&&(e.type=a.load,e.target=e.load),void(t.data=r.clone(e)))},n.FlowComponent.prototype.toFlow=function(){var e=this.data;return a(e.type,a.listener.type)?e.once?[e.event]:e.event:a(e.type,a.link.type)?new n.Handler({args:[e.link],handler:a.link.handler,isLink:!0,to:e.to}).toFlow():a(e.type,a.dataHandler.type)||a(e.type,a.streamHandler.type)||a(e.type,a.errorHandler.type)?new n.Handler({to:e.to,isStream:a(e.type,a.streamHandler),isError:a(e.type,a.errorHandler),args:e.args,handler:e.handler}).toFlow():a(e.type,a.load.type)?new n.Handler({args:[[e.target]],handler:a.load.handler}).toFlow():a(e.type,a.emit.type)?new n.Handler({args:[e.event],handler:a.emit.handler,to:e.to}).toFlow():void 0},n.TYPES=a,t.exports=n},{deffy:13,"map-o":15,typpy:19,ul:20}],15:[function(e,t){function n(e,t,n){return n&&(e=o.clone(e)),r(e,function(n,r,o){e[r]=t(r,n,o)}),e}var r=e("iterate-object"),o=e("ul");n.proto=function(){Object.prototype.map=function(e){return n(this,e)}},t.exports=n},{"iterate-object":17,ul:20}],16:[function(e,t){function n(e){return e=e||10,Math.random().toString(35).substr(2,e)}t.exports=n},{}],17:[function(e,t){function n(e,t){var n=0,r=[];if(Array.isArray(e))for(;n<e.length&&t(e[n],n,e)!==!1;++n);else for(r=Object.keys(e);n<r.length&&t(e[r[n]],r[n],e)!==!1;++n);}t.exports=n},{}],18:[function(e,t){function n(e,t,n){return e[t]=r(e[t],n)}var r=e("deffy");t.exports=n},{deffy:13}],19:[function(e,t){function n(e,t){return 2===arguments.length?n.is(e,t):n.get(e,!0)}n.is=function(e,t){return n.get(e,"string"==typeof t)===t},n.get=function(e,t){return"string"==typeof e?t?"string":String:null===e?t?"null":null:void 0===e?t?"undefined":void 0:e!==e?t?"nan":0/0:t?e.constructor.name.toLowerCase():e.constructor},t.exports=n},{}],20:[function(e,t){(function(n){function r(){}var o=e("typpy"),i=e("deffy");r.prototype.merge=function(e,t){var n={},r=null;t=i(t,{}),e=i(e,{});for(r in t)n[r]=t[r];for(r in e)void 0!==e[r]&&(n[r]=e[r]);return n},r.prototype.deepMerge=function(){for(var e,t,n={},r=[].splice.call(arguments,0);r.length>0;)if(e=r.splice(-1)[0],"object"===o(e))for(t in e)e.hasOwnProperty(t)&&("object"===o(e[t])?n[t]=this.deepMerge(e[t],n[t]||{}):void 0!==e[t]&&(n[t]=e[t]));return n},r.prototype.clone=function(e){if(!e)return e;var t,n,r=this,o=[Number,String,Boolean];if(o.forEach(function(n){e instanceof n&&(t=n(e))}),"undefined"==typeof t)if(Array.isArray(e))t=[],e.forEach(function(e,n){t[n]=r.clone(e)});else if("object"==typeof e)if(e.prototype)t=e;else if(e instanceof Date)t=new Date(e);else{t={};for(n in e)t[n]=r.clone(e[n])}else t=e;return t},r.prototype.HOME_DIR=n.env["win32"==n.platform?"USERPROFILE":"HOME"],r.prototype.home=function(){return this.HOME_DIR},t.exports=new r}).call(this,e("_process"))},{_process:1,deffy:13,typpy:21}],21:[function(e,t){function n(e){return"string"==typeof e?"string":null===e?"null":void 0===e?"undefined":e.constructor.name.toLowerCase()}t.exports=n},{}]},{},[12])(12)});